<!--
<img src="/images/pug.jpeg" alt="This is a cute pug." width="104" height="142">
<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
<input type="text" maxlength="4" size="4">
-->
<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="/stylesheets/bootstrap.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
  <title>gradecalc</title>

  <script>

  /* GLOBAL VARIABLES */
  var user = null;
  var li;
  /* GLOBAL VARIABLES */
  function calcluateGrades() {
    var marks = getMarks();
    var grades = getGrades();
    var finalMark = 0;
    if (marks.length == grades.length) {
      for(var i = 0; i < marks.length; i++)  {
        finalMark = finalMark + (marks[i] * (grades[i]/100));
      }
    }
    else {
      error();
    }
    $("#finalGrade").html(finalMark.toFixed(1) + "%");
  }

  function error()  {
    console.log("A grade or mark is missing");
  }


  // TODO: these functions need to be generalized
  function getMarks() {
    var arrayOfMarks = $(".marks");
    var marks = [];
    var x = 0;
    $.each(arrayOfMarks , function(index, value){
      if (value.value !== "")  {
        marks[x] = parseInt(value.value);
      }
      x++;
    });
    return marks;
  }

  function getGrades() {
    var arrayOfGrades = $(".grades");
    var grades = [];
    var x = 0;
    $.each(arrayOfGrades , function(index, value){
      if (value.value !== "")  {
        grades[x] = parseInt(value.value);
      }
      x++;
    });
    return grades;
  }

  function getUser(reqUser)  {
    $.getJSON("/getUser", {email: reqUser}, function(data) {
      user = data[0];
      if(user != undefined || user != null) {
        fillDropdown();
        fillGrades(0);
      }
    });
  }

  function fillDropdown() {
    var classes = user.classes;
    var list = document.getElementById("classDropdown");
    for (var i = 0; i < classes.length; i++)  {
      var opt = classes[i].className;
      var li = document.createElement("li");
      li.id = i;
      var link = document.createElement("a");
      var text = document.createTextNode(opt);
      link.appendChild(text);
      link.href = "#";
      li.appendChild(link);
      list.appendChild(li);
    }
    setDropdown();
  }

  function fillGrades(x) {
    var grades = user.classes[x].grades;
    var marks = user.classes[x].marks;
    var arrayOfMarks = $(".marks");
    var arrayOfGrades = $(".grades");
    clearTextBoxes('the-grades');
    for(var x = 0; x < grades.length; x++)  {
      arrayOfMarks[x].value = marks[x];
      arrayOfGrades[x].value = grades[x];
    }
  }

  // When page is loaded.
  $(function()  {
    var logInButton = document.getElementById('logInButton').addEventListener('click', function()  {
      var userEmail = document.getElementById('userEmail').value;
      if(userEmail != null || userEmail != undefined) {
        getUser(userEmail);
      }
    });
  });

  // Changes the Dropdown text to what class is selected
  function setDropdown()  {
    $(".dropdown-menu li a").click(function(){
      $(this).parents(".dropdown").find('.btn').html($(this).text() + ' <span class="caret"></span>');
      $(this).parents(".dropdown").find('.btn').val($(this).data('value'));
      var classIndexAsString = this.parentNode.id;
      if(classIndexAsString == "")  {
        // add a new class
      }
      else {
        var classIndexId = parseInt(classIndexAsString);
        fillGrades(classIndexId);
      }
    });
  }

  $(window).load(function(){
    //addDropDownClickEvent();
  });

  function clearTextBoxes(divID)  {
    $('#' + divID).find('input:text').each(function() {
      $(this).val('');
    }
  );
}
</script>

</head>
 <body style="width: 60%; margin: 0px auto;">   <!-- body style tag is there to centre the divs -->
  <h1> Welcome to gradecalc! </h1>
  <p> Please input your grades below </p>

  <div class="dropdown" >
    <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      Select your class
      <span class="caret"></span>
    </button>
    <ul id="classDropdown" class="dropdown-menu" aria-labelledby="dropdownMenu2">
      <li><a href="#">Add class</a></li>
      <li role="separator" class="divider"></li>
    </ul>
  </div>


  <div id="the-grades" >
    <table>
      <tr>
        <th>Your grade</th>
        <th>% of grade</th>
      </tr>
      <tr>
        <td>
          <input type="text" class="marks" id="mark1" maxlength="8" size="10" placeholder="ex 22/30">
        </td>
        <td>
          <input type="text" class="grades" id="grade1" maxlength="8" size="10" placeholder="ex 50">
        </td>
      </tr>
      <tr>
        <td>
          <input type="text" class="marks" id="mark2" maxlength="8" size="10">
        </td>
        <td>
          <input type="text" class="grades" id="grade2" maxlength="8" size="10">
        </td>
      </tr>
      <tr>
        <td>
          <input type="text" class="marks" id="mark3" maxlength="8" size="10">
        </td>
        <td>
          <input type="text" class="grades" id="grade3" maxlength="8" size="10">
        </td>
      </tr>
      <tr>
        <td>
          <input type="text" class="marks" id="mark4" maxlength="8" size="10">
        </td>
        <td>
          <input type="text" class="grades" id="grade4" maxlength="8" size="10">
        </td>
      </tr>
      <tr>
        <td>
          <input type="text" class="marks" id="mark5" maxlength="8" size="10">
        </td>
        <td>
          <input type="text" class="grades" id="grade5" maxlength="8" size="10">
        </td>
      </tr>
      <tr>
        <td>
          <input type="text" class="marks" id="mark6" maxlength="8" size="10">
        </td>
        <td>
          <input type="text" class="grades" id="grade6" maxlength="8" size="10">
        </td>
      </tr>
    </table>
  </div>
  <button type="button" id="markButton" onclick="calcluateGrades()" class="btn btn-default">What's my mark?</button>
  <div id="finalGrade"> </div>
  <label for="formGroupExampleInput">Email</label>
  <input type="text" class="form-control" id="userEmail" placeholder="email@me.com"> </input>
  <button type="button" id="logInButton" class="btn btn-default">Log in</button>

</body>
</html>
